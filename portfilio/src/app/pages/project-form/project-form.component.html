<app-header></app-header>

@if (showCancelModal) {
  <app-confirm-modal
    title="Annuler les modifications ?"
    message="Si vous quittez maintenant, vos modifications ne seront pas enregistrées."
    confirmText="Quitter sans sauver"
    cancelText="Continuer l'édition"
    (confirm)="confirmCancel()"
    (cancel)="closeModal()">
  </app-confirm-modal>
}

<main class="form-page">
  <div class="form-card">

    <h1 class="form-title">{{ isEditMode ? 'Modification d\'un projet' : 'Création d\'un projet' }}</h1>

    <form [formGroup]="projectForm" (ngSubmit)="onSubmit()">

      <div class="form-group">
        <label>Nom du projet <span class="req">*</span></label>
        <input type="text" formControlName="title" placeholder="Entrez le nom de votre projet...">
      </div>

      <div class="form-group">
        <label>Images du projet (Max 5) <span class="req">*</span></label>
        <p class="helper-text">Glissez-déposez pour réorganiser. La première est la couverture.</p>

        <div class="images-grid-editor">
          <input type="file" id="fileUpload" (change)="onFileSelected($event)" accept="image/*" hidden>

          @for (img of imagesArr.controls; track img; let i = $index) {
            <div class="img-slot filled"
                 [class.main]="i === 0"
                 draggable="true"
                 (dragstart)="onImgDragStart(i)"
                 (dragover)="onImgDragOver($event)"
                 (drop)="onImgDrop(i)">

              <div class="drag-indicator">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="5 9 2 12 5 15"></polyline><polyline points="9 5 12 2 15 5"></polyline><polyline points="15 19 12 22 9 19"></polyline><polyline points="19 9 22 12 19 15"></polyline><line x1="2" y1="12" x2="22" y2="12"></line><line x1="12" y1="2" x2="12" y2="22"></line></svg>
              </div>

              <img [src]="img.value" alt="Project img">
              <button type="button" class="btn-remove-img" (click)="removeImage(i)">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
              </button>
              @if (i === 0) { <span class="badge-main">Couverture</span> }
            </div>
          }

          @if (imagesArr.length < 5) {
            <div class="img-slot empty" (click)="triggerImageUpload()">
              <div class="add-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
              </div>
              <span>Ajouter</span>
            </div>
          }
        </div>
      </div>

      <div class="form-group">
        <label>Présentation générale du projet <span class="req">*</span></label>
        <textarea class="no-resize" formControlName="description" rows="5" placeholder="Entrez ici la présentation générale du projet..."></textarea>
      </div>

      <div class="form-group">
        <label>Langage(s) utilisé(s) <span class="req">*</span></label>
        <div class="chips-input-container">
          @for (tag of tagsArr.controls; track $index) {
            <span class="chip orange-chip">
              {{ tag.value }}
              <button type="button" class="btn-close-chip" (click)="removeTag($index)">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
              </button>
            </span>
          }
          <div class="autocomplete-wrapper js-tags-autocomplete">
            <input #tagInput type="text" placeholder="Nouvelle entrée..." (input)="onTagInput($event)" (keydown.enter)="$event.preventDefault(); addTag(tagInput.value, tagInput)">
            @if (filteredTags.length > 0) {
              <div class="autocomplete-dropdown">
                @for (suggestion of filteredTags; track suggestion) {
                  <div class="suggestion-item" (click)="addTag(suggestion, tagInput)">{{ suggestion }}</div>
                }
              </div>
            }
          </div>
        </div>
      </div>

      <div class="form-group">
        <label>Collaborateur(s) <span class="req">*</span></label>
        <div class="chips-input-container">
          @for (author of authorsArr.controls; track $index) {
            <span class="chip author-chip">
              {{ author.value.firstName }} {{ author.value.lastName | uppercase }}
              <button type="button" class="btn-close-chip" (click)="removeAuthor($index)">
                 <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
              </button>
            </span>
          }
          <div class="autocomplete-wrapper js-authors-autocomplete">
            <input #authInput
                   type="text"
                   placeholder="Nouvelle entrée..."
                   (input)="onAuthorInput($event)"
                   (keydown.enter)="onAuthorEnter($event, authInput)">

            @if (filteredUsers.length > 0) {
              <div class="autocomplete-dropdown">
                @for (user of filteredUsers; track user.id) {
                  <div class="suggestion-item" (click)="addAuthor(user, authInput)">
                    {{ user.firstName }} {{ user.lastName }}
                  </div>
                }
              </div>
            }
          </div>
        </div>
      </div>

      <div class="form-group">
        <label>Lien(s) du projet</label>

        <div class="links-stack" formArrayName="links">
          @for (link of linksArr.controls; track link; let i = $index) {
            <div [formGroupName]="i" class="link-row"
                 draggable="true"
                 (dragstart)="onLinkDragStart(i)"
                 (dragover)="onLinkDragOver($event)"
                 (drop)="onLinkDrop(i)">

              <div class="drag-handle">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="white" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"></circle><circle cx="9" cy="5" r="1"></circle><circle cx="9" cy="19" r="1"></circle><circle cx="15" cy="12" r="1"></circle><circle cx="15" cy="5" r="1"></circle><circle cx="15" cy="19" r="1"></circle></svg>
              </div>

              <div class="link-icon-wrapper">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
              </div>

              <input type="text" formControlName="title" list="linkTypes" class="input-title" placeholder="Titre (ex: Site Web)">
              <datalist id="linkTypes">
                @for (type of linkTypes; track type) { <option [value]="type"></option> }
              </datalist>

              <div class="separator">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
              </div>

              <input type="text" formControlName="url" class="input-url" placeholder="https://...">

              <button type="button" class="btn-remove-link" (click)="removeLink(i)">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
              </button>
            </div>
            @if (linksArr.at(i).get('url')?.invalid && linksArr.at(i).get('url')?.touched) {
              <div class="error-msg" style="margin-left: 50px; margin-top: -10px;">L'URL est requise si un titre est renseigné.</div>
            }
          }
        </div>

        <div class="add-link-wrapper">
          <button type="button" class="btn-new-option" (click)="addLink()">
            <div class="icon-circle">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </div>
            Nouvelle option
          </button>
        </div>
      </div>

      <div class="form-group">
        <label>Origine du projet <span class="req">*</span></label>
        <textarea class="no-resize" formControlName="origin" rows="3" placeholder="Pourquoi ce projet ? contexte..."></textarea>
      </div>

      <div class="form-group narrow">
        <label>Année de promotion <span class="req">*</span></label>
        <div class="select-wrapper">
          <select formControlName="promo">
            @for (p of promos; track p) { <option [value]="p">{{ p }}</option> }
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>Module(s) sollicité(s) <span class="req">*</span></label>
        <div class="chips-input-container">
          @for (mod of modulesArr.controls; track $index) {
            <span class="chip orange-chip">
              {{ mod.value }}
              <button type="button" class="btn-close-chip" (click)="removeModule($index)">×</button>
            </span>
          }
          <div class="autocomplete-wrapper js-modules-autocomplete">
            <input #modInput type="text" placeholder="Nouvelle entrée..." (input)="onModuleInput($event)" (keydown.enter)="$event.preventDefault(); addModule(modInput.value, modInput)">
            @if (filteredModules.length > 0) {
              <div class="autocomplete-dropdown">
                @for (suggestion of filteredModules; track suggestion) {
                  <div class="suggestion-item" (click)="addModule(suggestion, modInput)">{{ suggestion }}</div>
                }
              </div>
            }
          </div>
        </div>
      </div>

      <div class="form-group">
        <label>Ce que vous avez appris <span class="req">*</span></label>
        <textarea class="no-resize" formControlName="skillsLearned" rows="3" placeholder="Compétences techniques, gestion..."></textarea>
      </div>

      <div class="form-actions">
        <button type="button" class="btn-cancel" (click)="requestCancel()">Annuler</button>
        <button type="submit" class="btn-submit">
          {{ isEditMode ? 'Enregistrer les modifications' : 'Créer le projet' }}
        </button>
      </div>

    </form>
  </div>
</main>
<app-footer></app-footer>
